<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∏—Ç—Ä–∞—Ç</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --bg: #121212;
      --card: #1e1e1e;
      --text: #ffffff;
      --border: #ffffff30;
      --accent1: #ff6b6b;
      --accent2: #ff9f43;
      --accent3: #1e90ff;
      --accent4: #4caf50;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding-bottom: 60px;
    }

    h2 { margin-top: 25px; }

    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      background-color: var(--card);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 10px;
      border: 1px solid var(--border);
    }

    th { background-color: #2a2a2a; }

    .chart-container {
      width: 90%;
      margin: 40px auto;
      background-color: var(--card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
    }

    canvas { background: #181818; }

    .menu {
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: #1e1e1e;
      padding: 14px 0;
      position: fixed;
      bottom: 0;
      height: 55px;
      width: 100%;
      border-top: 1px solid #333;
    }

    .menu a {
      color: #ffffff;
      text-decoration: none;
      font-size: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .menu a:hover { color: #a2a2ff; }
    .material-icons { font-size: 24px; }
  </style>
</head>
<body>
  <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∏—Ç—Ä–∞—Ç</h2>
  <table id="expenseTable">
    <thead>
      <tr>
        <th>–î–∞—Ç–∞</th>
        <th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
        <th>–°—É–º–∞ (‚Ç¥)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="chart-container">
    <h2>üìÖ –í–∏—Ç—Ä–∞—Ç–∏ –ø–æ –¥–Ω—è—Ö</h2>
    <canvas id="dailyChart"></canvas>
  </div>

  <div class="chart-container">
    <h2>üìÇ –í–∏—Ç—Ä–∞—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö</h2>
    <canvas id="categoryChart"></canvas>
  </div>

  <div class="menu">
    <a href="/" title="–ì–æ–ª–æ–≤–Ω–∞"><span class="material-icons">home</span></a>
    <a href="add_spends" title="–í–∏—Ç—Ä–∞—Ç–∏"><span class="material-icons">add_circle</span></a>
    <a href="stats_check" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"><span class="material-icons">bar_chart</span></a>
    <a href="add_budget" title="–ë—é–¥–∂–µ—Ç"><span class="material-icons">account_balance_wallet</span></a>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    const userId = tg.initDataUnsafe?.user?.id;

    if (!userId) alert("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ user_id");

    async function loadStats() {
      const res = await fetch(`/get_expense_stats?user_id=${userId}`);
      const data = await res.json();
      const table = document.querySelector("#expenseTable tbody");
      const byDate = {};
      const byCategory = {};
      table.innerHTML = "";

      data.expenses.forEach(({ date, category, amount }) => {
        table.innerHTML += `<tr><td>${date}</td><td>${category}</td><td>${amount}</td></tr>`;
        byDate[date] = (byDate[date] || 0) + amount;
        byCategory[category] = (byCategory[category] || 0) + amount;
      });

      drawChart("dailyChart", Object.keys(byDate), Object.values(byDate), "bar");
      drawChart("categoryChart", Object.keys(byCategory), Object.values(byCategory), "doughnut");
    }

    function drawChart(id, labels, data, type) {
      new Chart(document.getElementById(id), {
        type,
        data: {
          labels,
          datasets: [{
            label: "–í–∏—Ç—Ä–∞—Ç–∏ (‚Ç¥)",
            data,
            backgroundColor: ["#ff6b6b", "#ff9f43", "#1e90ff", "#4caf50"]
          }]
        },
        options: {
          plugins: { legend: { labels: { color: "#fff" } } },
          scales: type === "bar" ? {
            y: { ticks: { color: "#fff" } },
            x: { ticks: { color: "#fff" } }
          } : {}
        }
      });
    }

    loadStats();
  </script>
  <div class="menu">
        <a href="/" title="–ì–æ–ª–æ–≤–Ω–∞"><span class="material-icons menu-icon">home</span></a>
        <a href="add_spends" title="–í–∏—Ç—Ä–∞—Ç–∏"><span class="material-icons menu-icon">add_circle</span></a>
        <a href="stats_check" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"><span class="material-icons menu-icon">bar_chart</span></a>
        <a href="add_budget" title="–ë—é–¥–∂–µ—Ç"><span class="material-icons menu-icon">account_balance_wallet</span></a>
    </div>
</body>
</html>
